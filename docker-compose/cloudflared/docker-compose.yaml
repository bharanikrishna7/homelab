# Docker Compose configuration for setting up a Cloudflare Tunnel container
#
# This configuration pulls the latest Cloudflare Tunnel image from the specified repository
# and includes options for logging, automatic updates using Watchtower, health checks, and volume mounting.

services:

  # Cloudflare Tunnel Service
  cloudflare-tunnel:
    # container image
    image: cloudflare/cloudflared:latest
    # container name
    container_name: cloudflared
    # container host
    hostname: ${HOST}
    
    # restart the container unless manually stopped
    restart: unless-stopped

    # logging configuration for container
    logging:
      # use the default json-file logging driver
      driver: "json-file"
      options:
        # maximum log file size before rotation (100 MB)
        max-size: "100m"
        # maximum number of log files to retain (10)
        max-file: "10"

    # use the host network (no isolation between host and container)
    network_mode: "host"

    # command to run on container start
    command: tunnel run

    # volume mapping from host to container
    volumes:
      # synchronize time with the host
      - /etc/localtime:/etc/localtime:ro

    # additional capabilities
    cap_add:
    # net admin privilege
    - NET_ADMIN
    # use RAW and PACKET sockets; bind to any address for transparent proxying.
    - NET_RAW
    # container should get some more processing time
    - SYS_NICE

    # environment variables for container
    environment:
      # cloudflare tunnel token
      - "TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}"

    # container health check
    healthcheck:
      # check if cloudflared version command works
      test: ["CMD", "cloudflared", "--version"]
      # time between health check attempts
      interval: 30s
      # time to wait for a response
      timeout: 10s
      # number of retries before marking as unhealthy
      retries: 3
      # delay before health checks begin
      start_period: 10s

    # deployment (docker compose up) settings
    deploy:
      # set resource limits
      resources:
        # maximum resource limits
        limits:
          cpus: '2'
          memory: 256m
        # minimum resource limits
        reservations:
          cpus: '0.2'
          memory: 16m

    # container labels
    labels:
      - 'admins.chekuri.org=true'