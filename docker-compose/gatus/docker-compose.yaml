# Docker Compose configuration for setting up a Gatus container
#
# This container will be responsible for monitoring services are
# up and running
#
# This service would be accessible at -> http://localhost:7000
services:
  
  # Gatus Container
  # refer here for additional parameters -> https://github.com/TwiN/gatus/tree/master/.examples/docker-compose-grafana-prometheus
  gatus:
    # container image
    image: twinproduction/gatus:latest
    # container name
    container_name: gatus
    # container hostname
    hostname: gatus
    
    # restart the container unless manually stopped
    restart: unless-stopped  
    
    # ports to be forwarded to host from container
    ports:
      # forwarding application port
      - 3080:8080

    # volume mapping from host to container
    volumes:
      # config file mapping
      - ./config:/config

    # container labels
    labels:
      - 'admins.chekuri.org=true'  
    
    # deployment (docker compose up) settings
    deploy:
      # set resource limits
      resources:
        # maximum resource limits
        limits:
          cpus: '0.1'
          memory: 512m
        # minimum resource limits
        reservations:
          cpus: '0.05'
          memory: 16m

    # container health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 120s
      timeout: 15s
      retries: 3
      start_period: 60s
      start_interval: 30s

  # oauth2-proxy container
  gatus-oauth2-proxy:
    # container image
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    # container name
    container_name: gatus-oauth2-proxy
    # container hostname
    hostname: ${HOSTNAME}
    
    # restart the container unless manually stopped
    restart: unless-stopped
    
    # command to run on container start
    command: --config /oauth2-proxy.cfg
    
    # volume mapping from host to container
    volumes:
      # oauth application configuration
      - "./oauth2-proxy.cfg:/oauth2-proxy.cfg"
    
    # ports to be forwarded from host to container
    ports:
      # forwarding oauth2-proxy port (4180) to host ()
      - 3000:4180

    # container labels
    labels:
      - 'admins.chekuri.org=true'

    # container depencencies
    depends_on:
      # depends on dozzle container
      dozzle:
        # container should be healthy
        condition: service_healthy
    
    # deployment (docker compose up) settings
    deploy:
      # set resource limits
      resources:
        # maximum resource limits
        limits:
          cpus: '0.05'
          memory: 128m
        # minimum resource limits
        reservations:
          cpus: '0.01'
          memory: 32m
